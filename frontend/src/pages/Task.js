import React, { useState, useEffect } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import { Settings, User, ArrowLeft } from 'lucide-react';
import toast from 'react-hot-toast';
import './Task.css';
import './LessonPage.css';
import { livesAPI } from '../services/api';

// Данные заданий для третьего урока
const getRentLesson3Tasks = (taskNum) => {
  const tasks = {
    1: {
      type: 'multiple_choice',
      title: 'Задание 1 Прочитай фрагмент договора и определи, законно ли арендодатель может так поступать.',
      text: 'Договор №1\n\n«Пункт 7. Прекращение действия договора\n\n7.1. Арендодатель вправе расторгнуть настоящий договор аренды в одностороннем порядке в целях обеспечения надлежащего состояния имущества и соблюдения условий пользования жилым помещением.\n\n7.2. В случае возникновения обстоятельств, требующих освобождения помещения для проведения профилактических, ремонтных либо иных технических мероприятий, Арендодатель уведомляет Арендатора в кратчайший возможный срок, в том числе с использованием устных или электронных средств связи.\n\n7.3. Арендатор обязуется освободить квартиру в течение 24 часов с момента получения соответствующего уведомления и обеспечить беспрепятственный доступ Арендодателя к помещению.\n\n7.4. Арендодатель не несёт ответственности за возможные неудобства, вызванные досрочным прекращением договора, а также не компенсирует стоимость неиспользованного периода проживания, если иное не будет согласовано сторонами отдельно.\n\n7.5. Настоящее условие направлено на обеспечение правомерного использования жилого помещения и не может рассматриваться как ущемляющее права Арендатора.\n\n7.6. Подтверждая согласие с указанными положениями, Арендатор подтверждает, что ознакомлен со всеми условиями расторжения и не имеет к Арендодателю претензий в случае досрочного прекращения договора по инициативе последнего.»',
      answers: [
        { id: 1, text: 'Да, если предупредил устно.' },
        { id: 2, text: 'Нет, расторгнуть можно только с уведомлением за 3 месяца.' },
        { id: 3, text: 'Да, если арендатор нарушил правила.' }
      ],
      correct_answers: [2],
      multiple: false,
      reference: {
        type: 'table',
        headers: ['Формулировка', 'Почему незаконна'],
        rows: [
          ['"в одностороннем порядке"', 'Нарушает ст. 687 ГК РФ — расторжение возможно только по закону и с уведомлением за 3 месяца'],
          ['"в кратчайший возможный срок / устно"', 'Обходит требование о письменном уведомлении и трёхмесячном сроке'],
          ['"освободить квартиру в течение 24 часов"', 'Противоречит нормам о защите прав нанимателя (ст. 687 ГК РФ)'],
          ['"не компенсирует стоимость неиспользованного периода"', 'Нарушает ст. 1102 ГК РФ (неосновательное обогащение)'],
          ['"не может рассматриваться как ущемляющее права арендатора"', 'Маскирует незаконные пункты под «согласие сторон»'],
          ['"подтверждает отсутствие претензий"', 'Лишает арендатора права на защиту в суде']
        ]
      }
    },
    2: {
      type: 'multiple_choice',
      title: 'Задание 2 Прочитай фрагмент договора и определи, законно ли арендодатель может так поступать.',
      text: 'Договор №2\n\n«Пункт 5. Обеспечение сохранности имущества и гарантия исполнения обязательств\n\n1.1. В целях подтверждения добросовестности исполнения обязательств Арендатор передаёт Арендодателю обеспечительный депозит в размере, эквивалентном месячной арендной плате.\n\n1.2. Депозит удерживается Арендодателем на весь срок действия настоящего договора и может быть использован для покрытия возможных расходов, связанных с восстановлением имущества, оплатой задолженности или иными обстоятельствами, возникающими по усмотрению Арендодателя.\n\n1.3. Возврат депозита осуществляется исключительно по усмотрению Арендодателя после проверки состояния квартиры и при отсутствии у него претензий к Арендатору.\n\n1.4. По согласованию сторон акт приёма-передачи имущества не составляется, так как квартира передаётся в технически исправном и надлежащем состоянии, что подтверждается визуальным осмотром Арендатора при заселении.\n\n1.5. Арендатор обязуется вернуть квартиру в том же состоянии, в каком она была получена, за исключением естественного износа, который определяется Арендодателем самостоятельно.\n\n1.6. Настоящий пункт направлен на защиту интересов обеих сторон и не является ограничением прав Арендатора.»',
      answers: [
        { id: 1, text: 'Нет, это нарушение закона — возврат депозита и акт передачи обязательны.' },
        { id: 2, text: 'Да, если квартира в хорошем состоянии, акт можно не составлять.' },
        { id: 3, text: 'Да, если стороны устно договорились, и арендатор согласился на эти условия.' },
        { id: 4, text: 'Нет, но арендодатель может вернуть депозит, если захочет.' }
      ],
      correct_answers: [1],
      multiple: false,
      reference: {
        type: 'table',
        headers: ['Формулировка', 'Что нарушает', 'Почему незаконно'],
        rows: [
          ['«Возврат депозита осуществляется по усмотрению Арендодателя»', 'Ст. 1102 ГК РФ — неосновательное обогащение', 'Деньги, не возвращённые без законных оснований, подлежат возврату в любом случае'],
          ['«При отсутствии претензий с его стороны»', 'Ст. 56 ГПК РФ — нельзя ставить возврат денег в зависимость от субъективного мнения', 'Претензии должны быть подтверждены документально'],
          ['«Акт приёма-передачи не составляется»', 'Ст. 674 ГК РФ — обязательное условие договора найма жилья', 'Без акта нельзя доказать, что имущество было передано в исправном состоянии'],
          ['«Арендодатель определяет износ самостоятельно»', 'Ст. 210, 622 ГК РФ — ответственность за износ делится по факту', 'Оценку состояния делает комиссия или обе стороны совместно'],
          ['«Может быть использован для любых обстоятельств»', 'Нарушение принципа конкретности условий договора (ст. 432 ГК РФ)', 'Деньги могут использоваться только для покрытий, прописанных и документально подтверждённых'],
          ['«Не является ограничением прав арендатора»', 'Маскирует ущемление прав', 'Такая формулировка не делает незаконный пункт законным']
        ]
      }
    },
    3: {
      type: 'multiple_choice',
      title: 'Задание 3 Прочитай фрагмент договора и определи, законно ли арендодатель может так поступать.',
      text: 'Договор №3\n\n«Пункт 6. Финансовые обязательства сторон\n\n1.1. В случае досрочного выезда Арендатора по любым причинам он обязуется оплатить арендную плату в полном объёме до конца срока действия договора, независимо от фактического проживания и пользования квартирой.\n\n1.2. Уплаченные суммы не подлежат возврату, а внесённые авансовые платежи считаются компенсацией за нарушение условий аренды.\n\n1.3. Коммунальные платежи оплачиваются ежемесячно в двойном размере, включая авансовый расчёт за возможные будущие начисления и перерасход.\n\n1.4. Арендатор подтверждает, что ознакомлен с указанными условиями и не имеет возражений относительно порядка расчётов, предусмотренного настоящим пунктом.\n\n1.5. Данное условие направлено на обеспечение своевременного поступления платежей и защиту имущественных интересов Арендодателя.»',
      answers: [
        { id: 1, text: 'Нет, удержание оплаты после выезда и двойная оплата коммунальных услуг — незаконны.' },
        { id: 2, text: 'Да, если стороны заранее согласовали эти условия.' },
        { id: 3, text: 'Да, если арендатор подписал договор и согласился с ними.' }
      ],
      correct_answers: [1],
      multiple: false,
      reference: {
        type: 'table',
        headers: ['Формулировка', 'Почему незаконна'],
        rows: [
          ['"оплатить аренду до конца срока, независимо от фактического проживания"', 'Нарушает ст. 310 и 450 ГК РФ — одностороннее удержание средств без предоставления услуги не допускается; арендодатель может требовать оплату только за фактически использованный период'],
          ['"уплаченные суммы не подлежат возврату"', 'Противоречит ст. 1102 ГК РФ — неосновательное обогащение, если квартира не используется'],
          ['"коммунальные платежи оплачиваются в двойном размере"', 'Нарушает ст. 153 и 155 ЖК РФ — жильцы оплачивают коммунальные услуги только по фактическому потреблению'],
          ['"в счёт возможных будущих начислений"', 'Противоречит принципу эквивалентности встречных обязательств — нельзя брать аванс без подтверждения услуги'],
          ['"не имеет возражений относительно порядка расчётов"', 'Лишает арендатора права оспаривать незаконные условия в будущем (нарушает ст. 16 Закона о защите прав потребителей)']
        ]
      }
    },
    4: {
      type: 'multiple_choice',
      title: 'Задание 4 Прочитай фрагмент договора и определи, законно ли арендодатель может так поступать.',
      text: 'Договор №4\n\n«Пункт 2. Основания передачи квартиры в аренду\n\n2.1. Гражданин Иванов И.И., действующий по устной договорённости с собственником жилого помещения, передаёт в аренду квартиру, расположенную по адресу: г. Москва, ул. Ленина, д. 89, кв. 119.\n\n2.2. Иванов И.И. подтверждает, что действует в интересах и с согласия собственника, который в настоящий момент отсутствует и не имеет возможности лично присутствовать при заключении договора.\n\n2.3. Доверенность от собственника не предоставляется, так как стороны находятся в доверительных отношениях и устно подтвердили согласие на сдачу жилья.\n\n2.4. Подписывая настоящий договор, Арендатор подтверждает, что не имеет претензий к правовому статусу Арендодателя и принимает условия аренды в полном объёме.\n\n2.5. Все спорные вопросы стороны обязуются решать вне судебного порядка, руководствуясь принципами добросовестности и взаимного доверия.»',
      answers: [
        { id: 1, text: 'Да, если стороны доверяют друг другу и устно всё согласовали.' },
        { id: 2, text: 'Да, если Иванов действительно имеет согласие собственника.' },
        { id: 3, text: 'Нет, сдавать квартиру без доверенности от собственника незаконно.' }
      ],
      correct_answers: [3],
      multiple: false,
      reference: {
        type: 'table',
        headers: ['Формулировка', 'Почему незаконна'],
        rows: [
          ['«действующий по устной договорённости с собственником»', 'Нарушает ст. 182 ГК РФ — представитель должен иметь письменную доверенность для распоряжения чужим имуществом.'],
          ['«доверенность не предоставляется»', 'Без доверенности Иванов не имеет права заключать договор аренды, договор считается ничтожным (ст. 168 ГК РФ).'],
          ['«арендатор не имеет претензий к правовому статусу арендодателя»', 'Пытается снять ответственность с посредника и лишает арендатора права на защиту в случае мошенничества.'],
          ['«споры решаются вне судебного порядка»', 'Нарушает ст. 11 Конституции РФ и ст. 3 ГПК РФ — граждане не могут быть лишены права на судебную защиту.'],
          ['«доверительные отношения»', 'Маскирует отсутствие юридических оснований. В гражданском праве "доверие" не заменяет полномочий.']
        ]
      }
    },
    5: {
      type: 'multiple_choice',
      title: 'Задание 5 Прочитай фрагмент договора и определи, законно ли арендодатель может так поступать.',
      text: 'Договор №5\n\n«Пункт 3. Общие условия аренды\n\n3.1. Арендодатель передаёт, а Арендатор принимает во временное пользование жилое помещение, расположенное по адресу: г. Москва, ул. Ленина, д. 89, кв. 119.\n\n3.2. Сумма арендной платы, срок проживания, порядок внесения платежей и условия оплаты коммунальных услуг определяются сторонами устно, исходя из взаимного доверия и сложившейся практики взаимоотношений.\n\n3.3. Настоящий документ составлен исключительно в целях подтверждения добрых намерений сторон, не являясь формальным юридическим обязательством.\n\n3.4. Арендатор подтверждает, что условия аренды ему понятны, и обязуется соблюдать договорённости в устной форме.\n\n3.5. В случае возникновения разногласий стороны обязуются урегулировать их самостоятельно, без обращения в компетентные органы.»',
      answers: [
        { id: 1, text: 'Да, если обе стороны согласны и доверяют друг другу.' },
        { id: 2, text: 'Да, если арендатор получил ключи и внёс оплату.' },
        { id: 3, text: 'Нет, такой договор не имеет юридической силы без указания суммы, срока и условий оплаты.' }
      ],
      correct_answers: [3],
      multiple: false,
      reference: {
        type: 'table',
        headers: ['Формулировка', 'Почему незаконна'],
        rows: [
          ['«сумма аренды, срок и условия оплаты оговариваются устно»', 'Нарушает ст. 432 и 674 ГК РФ — договор аренды жилья должен содержать все существенные условия: срок, размер платы и форму расчётов. Без этого договор считается не заключённым.'],
          ['«документ составлен для подтверждения добрых намерений»', 'Противоречит ст. 420 ГК РФ — договор создаёт права и обязанности, а не просто фиксирует "намерения".'],
          ['«устные договорённости»', 'Недопустимы в сделках с недвижимостью (ст. 161 ГК РФ) — такие сделки требуют письменной формы.'],
          ['«урегулировать разногласия самостоятельно, без обращения в органы»', 'Нарушает ст. 11 Конституции РФ и ст. 3 ГПК РФ — нельзя лишать человека права на судебную защиту.'],
          ['«доверие и устная форма»', 'Используется как завуалированная попытка обойти закон: устная форма не подтверждает обязательств сторон.']
        ]
      }
    },
    6: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 1',
      textParts: [
        { id: 1, text: '«Продаётся уютная 1-комнатная квартира в центре города, всего за ', isCorrect: false, clicked: false },
        { id: 2, text: '4 000 000 ₽!', isCorrect: true, clicked: false },
        { id: 3, text: ' Светлая, просторная, с новым дизайнерским ремонтом, мебелью и бытовой техникой. Заезжай и живи — ничего делать не нужно. ', isCorrect: false, clicked: false },
        { id: 4, text: 'Срочная продажа в связи с переездом, цена действует только сегодня.', isCorrect: true, clicked: false },
        { id: 5, text: ' ', isCorrect: false, clicked: false },
        { id: 6, text: 'Осмотр возможен по видеосвязи, так как собственник временно в командировке.', isCorrect: true, clicked: false },
        { id: 7, text: ' Для бронирования просьба внести небольшой задаток — всего ', isCorrect: false, clicked: false },
        { id: 8, text: '50 000 ₽, чтобы снять с публикации.', isCorrect: true, clicked: false },
        { id: 9, text: ' Документы готовы, ', isCorrect: false, clicked: false },
        { id: 10, text: 'покажу сканы по запросу.', isCorrect: true, clicked: false },
        { id: 11, text: '»', isCorrect: false, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Что нужно делать в таком случае:\n\n• Сравнить цену с аналогичными квартирами в этом районе.\n• Попросить точный адрес и показать квартиру лично, а не «по видеосвязи».\n• Не переводить задаток до личного осмотра и подписания договора.\n• Запросить оригиналы документов и выписку ЕГРН через сайт Росреестра.\n• Проверить телефон и имя продавца через поисковик.'
      }
    },
    7: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 2',
      textParts: [
        { id: 1, text: '«Продаётся просторная 2-комнатная квартира в современном ЖК «Элит-Парк». Качественный монолитный дом, развитая инфраструктура, охраняемая территория. ', isCorrect: false, clicked: false },
        { id: 2, text: 'Цена указана ориентировочно, актуальные предложения уточняйте у менеджера.', isCorrect: true, clicked: false },
        { id: 3, text: '  ', isCorrect: false, clicked: false },
        { id: 4, text: 'Этот объект уже забронирован, но есть другие аналогичные квартиры в этом же доме.', isCorrect: true, clicked: false },
        { id: 5, text: ' Позвоните, и мы подберём вариант под ваш бюджет — от 5 800 000 ₽. ', isCorrect: false, clicked: false },
        { id: 6, text: 'Осмотр возможен по предварительной записи через офис продаж.', isCorrect: true, clicked: false },
        { id: 7, text: ' При необходимости поможем с ипотекой и юридическим сопровождением.»', isCorrect: false, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Что нужно делать в таком случае:\n\n• Спросить точный адрес, корпус и секцию ЖК.\n• Проверить наличие этой квартиры на официальном сайте застройщика.\n• Не вносить «предоплату за подбор».\n• Проверить юрлицо агентства через ЕГРЮЛ (ФНС) и отзывы.\n• Проверить дату публикации.'
      }
    },
    8: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 3',
      textParts: [
        { id: 1, text: '«Срочно продаю 3-комнатную квартиру с видом на реку. Просторная гостиная, раздельные комнаты, свежий ремонт. ', isCorrect: false, clicked: false },
        { id: 2, text: 'Цена снижена до 3 000 000 ₽, только при быстрой сделке.', isCorrect: true, clicked: false },
        { id: 3, text: ' ', isCorrect: false, clicked: false },
        { id: 4, text: 'Возможен показ после внесения аванса 50 000 ₽ — для подтверждения серьёзности намерений.', isCorrect: true, clicked: false },
        { id: 5, text: ' Все документы в порядке, ', isCorrect: false, clicked: false },
        { id: 6, text: 'оригиналы на регистрации, предоставлю копии.', isCorrect: true, clicked: false },
        { id: 7, text: ' ', isCorrect: false, clicked: false },
        { id: 8, text: 'Собственник надёжный, работаем через доверенное лицо.', isCorrect: true, clicked: false },
        { id: 9, text: ' Квартира свободна, подходит под ипотеку. ', isCorrect: false, clicked: false },
        { id: 10, text: 'Успейте забронировать, предложение ограничено!»', isCorrect: true, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Что нужно делать в таком случае:\n\n• Никогда не переводить деньги до личного осмотра.\n• Попросить показать оригиналы документов лично.\n• Проверить адрес через Google Maps — реально ли там есть жилой дом.\n• Проверить собственника через выписку ЕГРН.\n• Если продавец настаивает на "доверенном лице" — попросить нотариальную доверенность.'
      }
    },
    9: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 4',
      textParts: [
        { id: 1, text: '«Продаётся 1-комнатная квартира в спальном районе. Тихие соседи, рядом магазины, детский сад и транспорт. ', isCorrect: false, clicked: false },
        { id: 2, text: 'Все документы заверены и находятся у нотариуса, сделка проводится быстро.', isCorrect: true, clicked: false },
        { id: 3, text: ' ', isCorrect: false, clicked: false },
        { id: 4, text: 'Оригиналы сейчас в другом городе, но есть копии — покажу при встрече.', isCorrect: true, clicked: false },
        { id: 5, text: ' ', isCorrect: false, clicked: false },
        { id: 6, text: 'При желании можем оформить через знакомого нотариуса, недорого и без проволочек.', isCorrect: true, clicked: false },
        { id: 7, text: ' Осмотр возможен по предварительной договорённости.»', isCorrect: false, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Что нужно делать в таком случае:\n\n• Попросить показать оригиналы документов.\n• Проверить адрес квартиры на карте (Google Maps, Яндекс.Карты) — убедиться, что объект действительно существует.\n• Заказать выписку из ЕГРН и проверить, кто является собственником.\n• Проверить указанного нотариуса через сайт notariat.ru — убедиться, что он реально существует.\n• Не соглашаться на сделку через "знакомого нотариуса" — требовать официальное оформление.\n• Не переводить деньги до личного осмотра квартиры и проверки документов.\n• Проверить номер телефона продавца в интернете — нет ли других объявлений с тем же контактом.\n• Настоять на личной встрече и осмотре квартиры до любых договорённостей.'
      }
    },
    10: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 5',
      textParts: [
        { id: 1, text: '«Продаётся уютная 2-комнатная квартира 58 м² в кирпичном доме 1995 года постройки. Квартира чистая, тёплая, в хорошем состоянии: косметический ремонт, стеклопакеты, заменены трубы. Собственник один, в собственности более 5 лет. Выписка ЕГРН и паспорт — при встрече. Осмотр возможен по выходным, торг уместен после просмотра. Тихий двор, рядом школа, магазины, остановка. Подходит под ипотеку, без обременений.»', isCorrect: false, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Это объявление выглядит безопасным, но всё равно стоит проверить документы при встрече.'
      }
    },
    11: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 6',
      textParts: [
        { id: 1, text: '«Продаётся элитная 4-комнатная квартира 130 м² с панорамным остеклением и дизайнерским ремонтом. Квартира полностью укомплектована техникой и мебелью. ', isCorrect: false, clicked: false },
        { id: 2, text: 'Документы готовы, покажем по запросу после внесения брони.', isCorrect: true, clicked: false },
        { id: 3, text: ' ', isCorrect: false, clicked: false },
        { id: 4, text: 'Работаем по доверенности от собственника, оформление у нотариуса.', isCorrect: true, clicked: false },
        { id: 5, text: ' Уникальное предложение для тех, кто ценит комфорт и престиж!»', isCorrect: false, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Что нужно делать в таком случае:\n\n• Никогда не вносить предоплату или "бронь" до личного осмотра квартиры. Требование оплатить «до показа» — частая схема мошенников.\n• Попросить показать оригиналы документов лично: свидетельство о праве собственности или выписку из ЕГРН.\n• Проверить доверенность, по которой якобы действует продавец: она должна быть нотариальной, с актуальной датой и без истёкшего срока действия.\n• Проверить данные доверенности через нотариальную палату — сайт notariat.ru покажет, существует ли такой документ.\n• Проверить собственника в ЕГРН (через rosreestr.gov.ru или «Госуслуги») — действительно ли продавец имеет право распоряжаться квартирой.\n• Настоять на личной встрече с доверенным лицом и сверить его паспортные данные с доверенностью.\n• Сверить адрес и фото квартиры с картами Google или Яндекса — бывает, что фото "элитного жилья" взяты из интернета.\n• Проверить номер телефона продавца в поиске и на ЦИАН/Авито — если один и тот же номер используется в разных регионах, это явный сигнал мошенничества.\n• Не соглашаться на "ускоренное оформление у знакомого нотариуса" — только через официального специалиста, выбранного обеими сторонами.\n• Заключать сделку только после проверки документов юристом или агентом по недвижимости.'
      }
    },
    12: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 7',
      textParts: [
        { id: 1, text: '«Продаётся 1-комнатная квартира площадью 35 м² с просторной кухней 20 м² и потолками 4 м. Квартира идеально подойдёт под сдачу в аренду. ', isCorrect: false, clicked: false },
        { id: 2, text: 'Все замеры производились вручную, поэтому возможны незначительные расхождения.', isCorrect: true, clicked: false },
        { id: 3, text: ' ', isCorrect: false, clicked: false },
        { id: 4, text: 'Адрес на карте указан верно, но дом пока не отображается в сервисах — новостройка без регистрации.', isCorrect: true, clicked: false },
        { id: 5, text: ' ', isCorrect: false, clicked: false },
        { id: 6, text: 'Документы предоставим на сделке, оформление быстрое.»', isCorrect: true, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Что нужно делать в таком случае:\n\n• Не переводить деньги за «бронь» до личного осмотра квартиры и проверки документов.\n• Попросить указать точный адрес и кадастровый номер объекта.\n• Заказать выписку из ЕГРН, чтобы проверить, кто является собственником.\n• Попросить показать оригинал доверенности, если продавец действует «по доверенности от собственника».\n• Проверить доверенность у нотариуса, который её выдал — действительно ли она существует и не отозвана.\n• Сделать обратный поиск фотографий квартиры через Google или Яндекс, чтобы убедиться, что они не взяты из стоков или других объявлений.\n• Проверить, указан ли нотариус в государственном реестре\n• Не соглашаться на сделку, если продавец избегает встречи, скрывает адрес или требует быстрых решений.'
      }
    },
    13: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 8',
      textParts: [
        { id: 1, text: '«Продаётся студия 22 м² после капитального ремонта, с индивидуальным отоплением. Чистая, светлая, окна на юг, тихий двор. Собственник один, без обременений. Выписка ЕГРН и паспорт — при встрече. Осмотр по договорённости, возможен торг при реальном интересе. Отличный вариант для студентов и тех, кто ищет небольшое жильё без лишних хлопот.»', isCorrect: false, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Что нужно делать в таком случае:\n\n• Проверить выписку из ЕГРН, чтобы убедиться, что продавец действительно является собственником.\n• Попросить показать оригиналы документов на квартиру и паспорт владельца при встрече.\n• Осмотреть квартиру лично — проверить соответствие описания (метраж, состояние, окна на юг, наличие индивидуального отопления).\n• Проверить, нет ли обременений (залог, арест, долги по коммуналке) через расширенную выписку ЕГРН.\n• Спросить, есть ли зарегистрированные жильцы, и потребовать их выписку до сделки.\n• Подписывать договор только после проверки всех документов у нотариуса или юриста.\n• Проводить расчёт безопасным способом — через нотариуса, эскроу-счёт или банковскую ячейку.'
      }
    },
    14: {
      type: 'highlight',
      question: 'Найди скрытый риск» — найдите все скрытые риски в описании объявления квартиры.\n\nОбъявление 9',
      textParts: [
        { id: 1, text: '«Продаётся 3-комнатная квартира 80 м², вторичка, один собственник, без обременений. Дом кирпичный, тёплый, рядом школа и парк. Выписка ЕГРН и коммунальные чеки предоставляются при осмотре. Осмотр по договорённости, торг уместен. Расчёт через нотариуса или банк, наличные не принимаем. Отличный вариант для семьи, всё готово к заселению.»', isCorrect: false, clicked: false }
      ],
      reference: {
        type: 'text',
        text: 'Это объявление выглядит безопасным, но всё равно стоит проверить документы при встрече.'
      }
    }
  };
  
  return tasks[taskNum] || null;
};

const Task = () => {
  const { topic, lessonNumber, taskNumber } = useParams();
  const navigate = useNavigate();
  const lessonNum = parseInt(lessonNumber, 10);
  const taskNum = parseInt(taskNumber, 10);
  const [answered, setAnswered] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [lives, setLives] = useState(null);
  const [taskData, setTaskData] = useState(null);
  const [taskState, setTaskState] = useState({});
  const [showReference, setShowReference] = useState(false);

  // Загружаем жизни и данные задания
  useEffect(() => {
    const loadData = async () => {
      try {
        const livesRes = await livesAPI.getMyLives();
        setLives(livesRes.data);
        
        // Загружаем данные задания
        let task = null;
        if (topic === 'rent' && lessonNum === 3) {
          task = getRentLesson3Tasks(taskNum);
        }
        setTaskData(task);
        
        // Сбрасываем состояние при переходе на новое задание
        setAnswered(false);
        setIsCorrect(false);
        setShowReference(false);
        
        // Инициализируем состояние задания
        if (task) {
          initializeTaskState(task);
        }
      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
      }
    };
    loadData();
  }, [topic, lessonNum, taskNum]);

  const initializeTaskState = (task) => {
    if (task.type === 'multiple_choice') {
      setTaskState({ selected: [] });
    } else if (task.type === 'highlight') {
      setTaskState({ 
        highlights: task.textParts ? task.textParts.map(p => ({ ...p })) : [],
        referenceVisible: false 
      });
    } else if (task.type === 'matching') {
      setTaskState({ 
        matches: task.matches ? task.matches.map(m => ({ ...m })) : [],
        showOptions: null 
      });
    }
  };

  const updateTaskState = (updates) => {
    setTaskState(prev => ({ ...prev, ...updates }));
  };

  // Проверяем, есть ли следующее задание
  const hasNextTask = () => {
    if (topic === 'rent' && lessonNum === 3) {
      return taskNum < 14; // Всего 14 заданий
    }
    return false;
  };

  const handleSubmit = async () => {
    if (!taskData) return;
    
    // Проверяем наличие жизней
    if (lives && lives.current_lives === 0) {
      toast.error('У вас закончились жизни! Вы не можете выполнять задания.');
      return;
    }

    // Если уже ответили правильно, не проверяем снова
    if (answered && isCorrect) {
      return;
    }

    // Проверяем ответы в зависимости от типа задания
    let correct = false;
    
    if (taskData.type === 'multiple_choice') {
      correct = checkMultipleChoice(taskData, taskState.selected || []);
    } else if (taskData.type === 'matching') {
      correct = checkMatching(taskData, taskState.matches || []);
    }

    // Если ответ неправильный, снимаем жизнь только один раз (при первом ответе)
    if (!correct && !answered) {
      try {
        await livesAPI.useLife();
        const livesRes = await livesAPI.getMyLives();
        setLives(livesRes.data);
        
        if (livesRes.data.current_lives === 0) {
          toast.error('У вас закончились жизни! Вы не можете выполнять задания.');
        } else {
          toast.error('Неправильный ответ. Снята одна жизнь.');
        }
      } catch (error) {
        console.error('Ошибка снятия жизни:', error);
      }
    }

    setAnswered(true);
    setIsCorrect(correct);
    setShowReference(true);

    if (correct) {
      toast.success('Правильный ответ!');
      // TODO: Обновить прогресс заданий
    }
  };

  const handleReset = () => {
    setAnswered(false);
    setIsCorrect(false);
    setShowReference(false);
    if (taskData.type === 'multiple_choice') {
      setTaskState({ selected: [] });
    } else if (taskData.type === 'matching') {
      setTaskState({ 
        matches: taskData.matches ? taskData.matches.map(m => ({ ...m, selected: null })) : [],
        showOptions: null 
      });
    }
  };

  const checkMultipleChoice = (task, selected) => {
    const correct = task.correct_answers || [];
    if (selected.length !== correct.length) return false;
    return selected.every(ans => correct.includes(ans));
  };

  const checkMatching = (task, matches) => {
    return matches.every(m => m.selected === m.correct);
  };

  const handleHighlightClick = async (partId) => {
    if (answered) return;
    
    const highlights = [...(taskState.highlights || [])];
    const part = highlights.find(p => p.id === partId);
    if (!part || part.clicked) return;

    part.clicked = true;
    part.selected = part.isCorrect;
    
    updateTaskState({ 
      highlights,
      referenceVisible: true 
    });

    if (!part.isCorrect) {
      // Снимаем жизнь при неправильном ответе
      if (lives && lives.current_lives > 0) {
        try {
          await livesAPI.useLife();
          const livesRes = await livesAPI.getMyLives();
          setLives(livesRes.data);
          toast.error('Неправильный ответ. Снята одна жизнь.');
        } catch (error) {
          console.error('Ошибка снятия жизни:', error);
        }
      }
    }
  };

  if (!taskData) {
    return (
      <div className="task-page">
        <div className="lesson-page-container">
          <div style={{ padding: '100px 20px', textAlign: 'center' }}>
            Загрузка...
          </div>
        </div>
      </div>
    );
  }

  const isHighlightTask = taskData?.type === 'highlight';
  const highlightReferenceVisible = Boolean(taskState?.referenceVisible);
  const shouldShowReference = Boolean(taskData.reference) && (isHighlightTask ? highlightReferenceVisible : showReference);

  return (
    <div className="task-page">
      <div className="lesson-page-container">
        {/* Шапка */}
        <div className="lesson-page-header">
          <div className="lesson-page-header-content">
            <div className="header-logo">ЛОГОТИП</div>
            <nav className="header-nav">
              <Link to="/dashboard" className="header-nav-link">Задания</Link>
              <Link to="/shop" className="header-nav-link">Магазин</Link>
            </nav>
            <div className="header-social-links">
              <Link to="/settings" className="header-social-icon">
                <Settings size={32} color="#000000" />
              </Link>
              <Link to="/profile" className="header-social-icon">
                <User size={32} color="#000000" />
              </Link>
            </div>
          </div>
        </div>

        {/* Кнопка назад */}
        <div className="lesson-page-back">
          <button 
            onClick={() => navigate(`/topic/${topic}/lesson/${lessonNum}`)}
            className="back-button"
          >
            <ArrowLeft size={20} />
            <span>Назад к уроку</span>
          </button>
        </div>

        {/* Основной контент */}
        <div className="task-content">
          <div className="task-frame">
            {renderTaskContent(taskData, taskState, updateTaskState, answered, isCorrect, handleHighlightClick)}
            
            {/* Справка внутри рамки */}
            {shouldShowReference && (
              <div className="task-reference" id="task-reference">
                {renderReference(taskData.reference)}
              </div>
            )}
          </div>

          {taskData.type !== 'highlight' && (
            <button 
              onClick={answered && !isCorrect ? handleReset : handleSubmit}
              disabled={(answered && isCorrect) || (lives && lives.current_lives === 0)}
              className="task-submit-button"
            >
              {answered && !isCorrect ? 'Попробовать заново' : 'Ответить'}
            </button>
          )}

          {/* Навигация между заданиями */}
          {answered && isCorrect && (
            <div className="task-navigation">
              {hasNextTask() ? (
                <button
                  onClick={() => {
                    navigate(`/topic/${topic}/lesson/${lessonNum}/task/${taskNum + 1}`);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                  }}
                  className="task-next-button"
                >
                  Следующее задание
                </button>
              ) : (
                <button
                  onClick={() => navigate(`/topic/${topic}/lesson/${lessonNum}`)}
                  className="task-next-button"
                >
                  Вернуться к уроку
                </button>
              )}
            </div>
          )}
        </div>

        {/* Футер */}
        <div className="lesson-page-footer">
          <div className="lesson-page-footer-content">
            <div className="footer-logo">ЛОГОТИП</div>
          </div>
        </div>
      </div>
    </div>
  );
};

// Рендеринг контента задания в зависимости от типа
const renderTaskContent = (task, taskState, updateTaskState, answered, isCorrect, handleHighlightClick) => {
  switch (task.type) {
    case 'multiple_choice':
      return (
        <MultipleChoiceTask 
          task={task} 
          taskState={taskState} 
          updateTaskState={updateTaskState}
          answered={answered}
          isCorrect={isCorrect}
        />
      );
    case 'highlight':
      return (
        <HighlightTask 
          task={task} 
          taskState={taskState} 
          handleHighlightClick={handleHighlightClick}
        />
      );
    case 'matching':
      return (
        <MatchingTask 
          task={task} 
          taskState={taskState} 
          updateTaskState={updateTaskState}
          answered={answered}
        />
      );
    default:
      return <div>Неизвестный тип задания</div>;
  }
};

// Компонент для заданий с выбором ответа
const MultipleChoiceTask = ({ task, taskState, updateTaskState, answered, isCorrect }) => {
  const selected = taskState.selected || [];

  const handleAnswerSelect = (answerId) => {
    // Блокируем изменение ответа после того, как ответили (до нажатия "Попробовать заново")
    if (answered) return;
    
    if (task.multiple) {
      // Множественный выбор
      const newSelected = selected.includes(answerId) 
        ? selected.filter(id => id !== answerId)
        : [...selected, answerId];
      updateTaskState({ selected: newSelected });
    } else {
      // Одиночный выбор
      updateTaskState({ selected: [answerId] });
    }
  };

  return (
    <div className="multiple-choice-task">
      <h2>{task.title}</h2>
      <div className="task-text">{task.text}</div>
      <div className="task-prompt">Выбери правильный вариант:</div>
      <div className="answers-list">
        {task.answers.map((answer) => {
          const isSelected = selected.includes(answer.id);
          let answerClass = 'answer-option';
          
          if (answered) {
            // При неправильном ответе подсвечиваем только выбранный неправильный вариант красным
            if (!isCorrect) {
              if (isSelected && !task.correct_answers.includes(answer.id)) {
                answerClass += ' answer-incorrect';
              }
            } else {
              // При правильном ответе подсвечиваем правильные варианты зеленым
              const isCorrectAnswer = task.correct_answers.includes(answer.id);
              if (isCorrectAnswer) {
                answerClass += ' answer-correct';
              }
            }
          } else if (isSelected) {
            answerClass += ' answer-selected';
          }

          return (
            <div
              key={answer.id}
              className={answerClass}
              onClick={() => handleAnswerSelect(answer.id)}
              style={{ cursor: answered ? 'default' : 'pointer' }}
            >
              {answer.text}
            </div>
          );
        })}
      </div>
    </div>
  );
};

// Компонент для заданий с выделением текста
const HighlightTask = ({ task, taskState, handleHighlightClick }) => {
  const highlights = taskState.highlights || [];

  return (
    <div className="highlight-task">
      <h2>{task.question}</h2>
      <div className="highlight-text">
        {highlights.map((part) => {
          let partClass = 'text-part';
          if (part.clicked) {
            partClass += part.isCorrect ? ' part-correct' : ' part-incorrect';
          }

          return (
            <span
              key={part.id}
              className={partClass}
              onClick={() => handleHighlightClick(part.id)}
            >
              {part.text}
            </span>
          );
        })}
      </div>
    </div>
  );
};

// Компонент для заданий на сопоставление
const MatchingTask = ({ task, taskState, updateTaskState, answered }) => {
  const matches = taskState.matches || [];
  const showOptions = taskState.showOptions;

  const handleCellClick = (matchId) => {
    if (answered) return;
    updateTaskState({ showOptions: showOptions === matchId ? null : matchId });
  };

  const handleOptionSelect = (matchId, optionId) => {
    const updatedMatches = matches.map(m => 
      m.id === matchId ? { ...m, selected: optionId } : m
    );
    updateTaskState({ 
      matches: updatedMatches,
      showOptions: null 
    });
  };

  return (
    <div className="matching-task">
      <h2>{task.question}</h2>
      <table className="matching-table">
        <thead>
          <tr>
            <th>№</th>
            <th>Ситуация</th>
            <th>Вариант ответа</th>
            <th>Пояснение</th>
          </tr>
        </thead>
        <tbody>
          {matches.map((match, index) => {
            const isCorrect = match.selected === match.correct;
            let cellClass = 'match-cell';
            if (answered) {
              cellClass += isCorrect ? ' correct' : ' incorrect';
            }

            return (
              <tr key={match.id}>
                <td>{index + 1}</td>
                <td>{match.situation}</td>
                <td style={{ position: 'relative' }}>
                  <div 
                    className={cellClass}
                    onClick={() => handleCellClick(match.id)}
                  >
                    {match.selected ? (
                      <span className="selected-option">
                        {task.options.find(o => o.id === match.selected)?.text}
                      </span>
                    ) : (
                      <span className="placeholder">Выберите вариант ответа</span>
                    )}
                    {answered && (
                      <span className="result-icon">
                        {isCorrect ? (
                          <svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fillRule="evenodd" clipRule="evenodd" d="M18.7813 8.30158C19.0864 8.60667 19.0864 9.10133 18.7813 9.40643L11.4896 16.6981C11.1845 17.0032 10.6898 17.0032 10.3847 16.6981L6.21808 12.5314C5.91298 12.2263 5.91298 11.7317 6.21808 11.4266C6.52318 11.1215 7.01784 11.1215 7.32293 11.4266L10.9372 15.0408L17.6764 8.30158C17.9815 7.99648 18.4762 7.99648 18.7813 8.30158Z" fill="#91AE0D" stroke="#91AE0D" strokeLinecap="round" strokeLinejoin="round"/>
                          </svg>
                        ) : (
                          <svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8.81692 16.1831L16.1826 8.81738" stroke="#F8202B" strokeWidth="2.5" strokeLinecap="round"/>
                            <path d="M8.81692 8.81692L16.1826 16.1826" stroke="#F8202B" strokeWidth="2.5" strokeLinecap="round"/>
                          </svg>
                        )}
                      </span>
                    )}
                  </div>
                  {showOptions === match.id && (
                    <div className="options-dropdown">
                      {task.options.map(option => (
                        <div
                          key={option.id}
                          className="option-item"
                          onClick={() => handleOptionSelect(match.id, option.id)}
                        >
                          {option.text}
                        </div>
                      ))}
                    </div>
                  )}
                </td>
                <td className={answered ? 'explanation-visible' : 'explanation-hidden'}>
                  {match.explanation}
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    </div>
  );
};

// Рендеринг справки
const renderReference = (reference) => {
  if (reference.type === 'table') {
    return (
      <table className="reference-table">
        <thead>
          <tr>
            {reference.headers.map((header, i) => (
              <th key={i}>{header}</th>
            ))}
          </tr>
        </thead>
        <tbody>
          {reference.rows.map((row, i) => (
            <tr key={i}>
              {row.map((cell, j) => (
                <td key={j}>{cell}</td>
              ))}
            </tr>
          ))}
        </tbody>
      </table>
    );
  }
  return <div className="reference-text">{reference.text}</div>;
};

export default Task;
